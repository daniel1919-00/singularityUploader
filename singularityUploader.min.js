var singularityUploader={instances:[],create:function(e,t){var s=document.getElementById(e);if(!s)return console.log("Uploader Error: Invalid target!"),-1;if(this.util.hasClass(s,"_sg-uploader-container")){console.log("Duplicate instance!");var i=s.getAttribute("data-instance-id");return null!==i?Number(i):-1}t=t||{},t=this.util.extend(!0,{transferDestination:"",allowedFileExtensions:[],maxFileSize:null,maxConcurentTransfers:5,maxFileChunkSize:2097152,multipleFiles:!1,sessionName:"singularityUpload",maxRetries:3,success:null,error:null,uploadButtonText:"Upload",selectFilesText:"Select Files",dropAreaText:"Drop files here"},t);var r=document.createElement("input");r.setAttribute("type","file"),r.setAttribute("class","_sg-uploader-input"),t.multipleFiles&&r.setAttribute("multiple","multiple"),t.allowedFileExtensions.length&&r.setAttribute("accept","."+t.allowedFileExtensions.join(",.")),r.options=t,r.fileQueue=[],r.chunksQueue=[],r.fileErrors={},r.errors=0,r.totalFileChunks=0,r.totalUploadedChunks=0,r.activeTransfers=0,r.waitingActiveTransfers={waitingFinalTransfers:!1},r.handleError=this.handleError,r.initTransfer=this.initTransfer,r.transferFile=this.transferFile,r.onchange=this.processInputFiles,r.updateFileProgress=this.updateFileProgress,r.updateOverallProgress=this.updateOverallProgress,r.updateFileStatus=this.updateFileStatus,r.fileHasErrors=this.fileHasErrors;var n=this.instances.push(r)-1;r.instanceId=n,r.setAttribute("id","_sg-uploader-input"+n),s.innerHTML='<div class="_sg-uploader-dropArea">'+t.dropAreaText+"</div>",s.appendChild(r);var a=document.createElement("button");a.setAttribute("id","_sg-uploader-button"+n),a.setAttribute("class","btn btn-primary btn-sm _sg-uploader-button"),a.innerHTML=t.uploadButtonText,a.style.display="none",a.onclick=function(e){e.preventDefault();var t=document.getElementById("_sg-uploader-fileProgressContainer"+n);t&&(t.style.display="inline-flex"),r.initTransfer()};var l=document.createElement("label");return l.innerHTML='<div class="btn btn-primary btn-sm">'+t.selectFilesText+"</div>",l.setAttribute("for","_sg-uploader-input"+n),l.setAttribute("class","_sg-uploader-fileLabel"),s.appendChild(l),l.appendChild(a),r.uploadButton=a,s.classList.add("_sg-uploader-container"),s.setAttribute("data-instance-id",n),["dragenter","dragover","dragleave","drop"].forEach(function(e){s.addEventListener(e,function(e){e.preventDefault(),e.stopPropagation()},!1)}),["dragenter","dragover"].forEach(function(e){s.addEventListener(e,function(){s.classList.add("highlight")},!1)}),["dragleave","drop"].forEach(function(e){s.addEventListener(e,function(){s.classList.remove("highlight")},!1)}),s.addEventListener("drop",function(e){e.dataTransfer&&e.dataTransfer.files&&(r.files=e.dataTransfer.files)},!1),n},getInstance:function(e){return this.instances[e]},processInputFiles:function(){var e,t;if(this.fileList?((e=this.fileList).innerHTML="",t=!1,this.totalFileChunks=0,this.totalUploadedChunks=0):(e=document.createElement("ul"),t=!0),e){for(var s,i,r,n,a,l,o,u,d=this,c=0,f=d.options.maxFileChunkSize,p=0,h=d.files,g=h.length,v=d.instanceId,m=function(){this.checked?d.fileQueue.push(this.fileIndex):d.fileQueue.splice(this.fileIndex,1)};c<g;++c){if(n=h[c],s=document.createElement("li"),o=document.createElement("div"),r=document.createElement("label"),r.innerHTML="&nbsp; "+n.name,r.setAttribute("for","_sg-uploader-fileStatusCheckbox"+v+c),r.setAttribute("class","_sg-uploader-fileStatusCheckbox"),(i=document.createElement("input")).setAttribute("type","checkbox"),i.setAttribute("id","_sg-uploader-fileStatusCheckbox"+v+c),i.fileIndex=c,i.checked=!0,i.onchange=m,a=Math.ceil(n.size/f),d.totalFileChunks+=a,a<2)d.chunksQueue[c]=[{chunkId:0,retries:0,totalChunks:a}];else{for(l=[],p=0;p<a;++p)u=p*f,l.push({chunkId:p,retries:0,totalChunks:a,dataBegin:u,dataEnd:u+f});d.chunksQueue[c]=l.reverse()}d.fileQueue.push(c),s.appendChild(i),s.appendChild(r),o.innerHTML='<div id="_sg-uploader-fileProgressContainer'+v+c+'" class="_sg-uploader-fileProgress progress" style="width: 85px;display:none;vertical-align:middle;"><div id="_sg-uploader-fileProgress'+v+c+'" class="progress-bar" role="progressbar" style="width:0;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div></div>',o.setAttribute("class","_sg-uploader-fileStatus"),o.setAttribute("id","_sg-uploader-fileStatusContainer"+v+c),o.setAttribute("style","width: 100%;display:inline;margin-left:10px;"),s.appendChild(o),e.appendChild(s)}if(d.uploadButton.style.display="inline-block",t){e.setAttribute("class","_sg-uploader-filesList"),e.setAttribute("id","_sg-uploader-filesList"+v);var T=document.createElement("div");T.innerHTML='<div id="_sg-uploader-fileProgressContainer'+v+'" class="_sg-uploader-fileProgress progress" style="width: 85px;display:none;vertical-align:middle;"><div id="_sg-uploader-fileProgress'+v+'" class="progress-bar" role="progressbar" style="width:0;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div></div>',d.parentNode.appendChild(T),d.parentNode.appendChild(e),d.fileList=e}}},initTransfer:function(){var e=this;if(0===e.fileQueue.length)if(0===e.activeTransfers){var t=document.getElementById("_sg-uploader-fileProgressContainer"+this.instanceId);t&&t.remove(),e.uploadButton.style.display="none",e.errors?null!==this.options.error&&this.options.error.call(this):(!1!==e.waitingActiveTransfers.waitingFinalTransfers&&(clearTimeout(e.waitingActiveTransfers.waitingFinalTransfers),e.waitingActiveTransfers.waitingFinalTransfers=!1),null!==this.options.success&&this.options.success.call(this))}else!1===e.waitingActiveTransfers.waitingFinalTransfers&&(e.waitingActiveTransfers.waitingFinalTransfers=setTimeout(function(){e.waitingActiveTransfers.waitingFinalTransfers=!1,e.initTransfer()},100));else{var s=e.fileQueue.pop(),i=document.getElementById("_sg-uploader-fileProgressContainer"+e.instanceId+s);i&&(i.style.display="inline-flex"),e.transferFile(s)}},transferFile(e){var t=this,s=this.files[e];if(0===t.chunksQueue[e].length)return void 0!==t.waitingActiveTransfers[e]&&(clearTimeout(t.waitingActiveTransfers[e]),delete t.waitingActiveTransfers[e]),t.fileHasErrors(e)||t.updateFileStatus(e,!0),void setTimeout(function(){t.initTransfer()},0);if(t.activeTransfers+1>t.options.maxConcurentTransfers)void 0===t.waitingActiveTransfers[e]&&(t.waitingActiveTransfers[e]=setTimeout(function(){delete t.waitingActiveTransfers[e],t.transferFile(e)},200));else{void 0!==t.waitingActiveTransfers[e]&&(clearTimeout(t.waitingActiveTransfers[e]),delete t.waitingActiveTransfers[e]);var i,r=t.chunksQueue[e].pop(),n=r.chunkId,a=r.totalChunks,l=s.name,o=s.size+"",u=t.options.maxRetries,d=new XMLHttpRequest;d.open("post",t.options.transferDestination,!0),d.setRequestHeader("Content-Type","application/octet-stream"),d.setRequestHeader("X-Chunk-Id",n),d.setRequestHeader("X-Chunk-Checksum",singularityUploader.util.calcCrc32(""+n+l+o)),d.setRequestHeader("X-Content-Length",o),d.setRequestHeader("X-Content-Name",l),d.setRequestHeader("X-Session-Name",t.options.sessionName),d.setRequestHeader("X-Chunk-Count",a),d.onerror=function(){r.retries>=u?t.handleError("chunk id :"+n+" transfer fail!"):(++r.retries,t.chunksQueue[e].push(r))},d.onreadystatechange=function(){if(4===d.readyState)if(--t.activeTransfers,200===d.status)if((i=JSON.parse(d.response)).success){if(t.fileHasErrors(e))return;++t.totalUploadedChunks,t.updateFileProgress(e,Math.round((a-t.chunksQueue[e].length)/a*100))}else if(i.recoverable){if(t.fileHasErrors(e))return;r.retries>=u?t.handleError("chunk id :"+n+" transfer fail!"):(++r.retries,t.chunksQueue[e].push(r))}else t.chunksQueue[e].length&&(t.fileErrors[e]=i.msg,t.chunksQueue[e]=[],++t.errors,t.updateFileStatus(e,!1,i.msg));else r.retries>=u?t.handleError("chunk id :"+n+" transfer fail!"):(++r.retries,t.chunksQueue[e].push(r))},++t.activeTransfers,d.send(1===a?s:s.slice(r.dataBegin,r.dataEnd)),setTimeout(function(){t.transferFile(e)},0)}},updateFileProgress:function(e,t){var s=document.getElementById("_sg-uploader-fileProgress"+this.instanceId+e);s&&(t+="%",s.style.width=t,s.innerHTML=t),this.updateOverallProgress()},updateOverallProgress:function(){var e=document.getElementById("_sg-uploader-fileProgress"+this.instanceId),t=Math.round(this.totalUploadedChunks/this.totalFileChunks*100)+"%";e&&(e.style.width=t,e.innerHTML=t)},updateFileStatus:function(e,t,s){s=s||"";var i=document.getElementById("_sg-uploader-fileStatusCheckbox"+this.instanceId+e),r=document.getElementById("_sg-uploader-fileStatusContainer"+this.instanceId+e),n=t?'<i class="fas fa-check" style="color:green;"></i> ':'<i class="fas fa-times" style="color:red;"></i> ';i&&i.remove(),r&&(r.innerHTML=n+s)},fileHasErrors:function(e){return void 0!==this.fileErrors[e]},handleError:function(e){console.log(e)},util:{hasClass:function(e,t){return-1!==e.className.indexOf(t.trim())},extend:function(){var e,t,s=arguments.length,i=!0===arguments[0],r=1;for(i?(r=2,e=arguments[1]):e=arguments[0];r<s;++r)(t=arguments[r])&&this.forEach(t,function(t,s){i&&e[s]&&("object"==typeof t||Array.isArray(t))?e[s]=singularityUploader.util.extend(e[s],t):e[s]=t});return e},forEach:function(e,t){var s;if(Array.isArray(e)){var i=e.length;for(s=0;s<i;++s)t(e[s],s)}else for(s in e)e.hasOwnProperty(s)&&t(e[s],s)},calcCrc32:function(e){var t=window.crcTable||[];if(!window.crcTable){var s,i,r;for(i=0;i<256;++i){for(s=i,r=0;r<8;++r)s=1&s?3988292384^s>>>1:s>>>1;t[i]=s}window.crcTable=t}var n,a=-1;for(n=0;n<e.length;++n)a=a>>>8^t[255&(a^e.charCodeAt(n))];return(-1^a)>>>0}}};