var singularityUploader={instances:[],create:function(e,t){var i=document.getElementById(e);if(!i)return console.log("Uploader Error: Invalid target!"),-1;if(this.util.hasClass(i,"_sg-uploader-container")){console.log("Duplicate instance!");var s=i.getAttribute("data-instance-id");return null!==s?Number(s):-1}var r=document.createElement("input");r.setAttribute("type","file"),r.setAttribute("class","_sg-uploader-input"),t=t||{},(t=this.util.extend(!0,{transferDestination:"",allowedFileExtensions:[],maxFileSize:null,maxConcurrentTransfers:5,maxFileChunkSize:2097152,multipleFiles:!1,sessionName:"singularityUpload",maxRetries:3,success:null,error:null,buttons:[{text:"Clear Files",attributes:{class:"btn btn-primary btn-sm _sg-uploader-button _sg-uploader-actionButton",onclick:function(e){e.preventDefault(),r.clearTransferQueue()}}},{text:"Upload",attributes:{class:"btn btn-primary btn-sm _sg-uploader-button _sg-uploader-actionButton",onclick:function(e){e.preventDefault();var t=document.getElementById("_sg-uploader-fileProgressContainer"+n);t&&(t.style.display="inline-flex"),r.initTransfer()}}}],selectFilesText:"Select Files",dropAreaText:"Drop files here",invalidFilesErrorHandler:function(e,t){alert(t.fileErrorTexts.general+"\n\n"+e.join("\n"))},fileErrorTexts:{general:"The files bellow have an invalid extension or are bigger than the maximum allowed",sizeError:"File exceeds maximum allowed size",extensionError:"File does not have the allowed extension"}},t)).multipleFiles&&r.setAttribute("multiple","multiple"),t.allowedFileExtensions.length&&r.setAttribute("accept","."+t.allowedFileExtensions.join(",.")),r.options=t,r.fileQueue=[],r.chunksQueue=[],r.fileErrors={},r.errors=0,r.totalFileChunks=0,r.totalUploadedChunks=0,r.activeTransfers=0,r.waitingActiveTransfers={waitingFinalTransfers:!1},r.handleError=this.handleError,r.initTransfer=this.initTransfer,r.transferFile=this.transferFile,r.onchange=this.processInputFiles,r.updateFileProgress=this.updateFileProgress,r.updateOverallProgress=this.updateOverallProgress,r.updateFileStatus=this.updateFileStatus,r.fileHasErrors=this.fileHasErrors,r.clearTransferQueue=this.clearTransferQueue;var n=this.instances.push(r)-1;r.instanceId=n,r.setAttribute("id","_sg-uploader-input"+n),i.appendChild(r);var a=document.createElement("div");a.setAttribute("class","_sg-uploader-actionButtons"),a.style.display="none";var l,o,u,d,c=t.buttons.length;if(t.buttons.length)for(u=0;u<c;++u){if(o=t.buttons[u],l=document.createElement("button"),l.innerHTML=o.text,o.attributes)for(d in o.attributes)"function"==typeof o.attributes[d]?l[d]=o.attributes[d]:l.setAttribute(d,o.attributes[d]);a.appendChild(l)}var f=document.createElement("label");f.innerHTML='<div class="btn btn-primary btn-sm">'+t.selectFilesText+"</div>",f.setAttribute("for","_sg-uploader-input"+n),f.setAttribute("class","_sg-uploader-fileLabel"),i.appendChild(f);var p=document.createElement("div");p.innerHTML=t.dropAreaText,p.setAttribute("class","_sg-uploader-dropArea"),i.appendChild(p),f.appendChild(a),r.actionButtons=a,i.classList.add("_sg-uploader-container"),i.setAttribute("data-instance-id",n);var h=document.createElement("ul");h.setAttribute("class","_sg-uploader-filesList"),h.setAttribute("id","_sg-uploader-filesList"+n);var g=document.createElement("div");return g.innerHTML='<div id="_sg-uploader-fileProgressContainer'+n+'" class="_sg-uploader-fileProgress progress" style="width: 85px;display:none;vertical-align:middle;"><div id="_sg-uploader-fileProgress'+n+'" class="progress-bar" role="progressbar" style="width:0;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div></div>',i.appendChild(g),i.appendChild(h),r.fileList=h,["dragenter","dragover","dragleave","drop"].forEach(function(e){i.addEventListener(e,function(e){e.preventDefault(),e.stopPropagation()},!1)}),["dragenter","dragover"].forEach(function(e){i.addEventListener(e,function(){i.classList.add("highlight")},!1)}),["dragleave","drop"].forEach(function(e){i.addEventListener(e,function(){i.classList.remove("highlight")},!1)}),i.addEventListener("drop",function(e){e.dataTransfer&&e.dataTransfer.files&&(r.files=e.dataTransfer.files)},!1),n},getInstance:function(e){return this.instances[e]},processInputFiles:function(){var e=this.fileList;if(e){""!==e.innerHTML&&(e.innerHTML="",this.totalFileChunks=0,this.totalUploadedChunks=0);for(var t,i,s,r,n,a,l,o,u=this,d=0,c=u.options.maxFileChunkSize,f=u.options.maxFileSize,p=u.options.allowedFileExtensions,h=0,g=u.files,v=g.length,m=u.instanceId,T=[],b=function(){this.checked?u.fileQueue.push(this.fileIndex):u.fileQueue.splice(this.fileIndex,1)};d<v;++d)if(r=g[d],null!==f&&r.size>f)T.push(r.name+" ("+u.options.fileErrorTexts.sizeError+")");else if(p.length&&-1===p.indexOf(singularityUploader.util.extractFileExtensionFromString(r.name)))T.push(r.name+" ("+u.options.fileErrorTexts.extensionError+")");else{if(t=document.createElement("li"),l=document.createElement("div"),s=document.createElement("label"),s.innerHTML="&nbsp; "+r.name,s.setAttribute("for","_sg-uploader-fileStatusCheckbox"+m+d),s.setAttribute("class","_sg-uploader-fileStatusCheckbox"),(i=document.createElement("input")).setAttribute("type","checkbox"),i.setAttribute("id","_sg-uploader-fileStatusCheckbox"+m+d),i.fileIndex=d,i.checked=!0,i.onchange=b,n=Math.ceil(r.size/c),u.totalFileChunks+=n,n<2)u.chunksQueue[d]=[{chunkId:0,retries:0,totalChunks:n}];else{for(a=[],h=0;h<n;++h)o=h*c,a.push({chunkId:h,retries:0,totalChunks:n,dataBegin:o,dataEnd:o+c});u.chunksQueue[d]=a.reverse()}u.fileQueue.push(d),t.appendChild(i),t.appendChild(s),l.innerHTML='<div id="_sg-uploader-fileProgressContainer'+m+d+'" class="_sg-uploader-fileProgress progress" style="width: 85px;display:none;vertical-align:middle;"><div id="_sg-uploader-fileProgress'+m+d+'" class="progress-bar" role="progressbar" style="width:0;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div></div>',l.setAttribute("class","_sg-uploader-fileStatus"),l.setAttribute("id","_sg-uploader-fileStatusContainer"+m+d),l.setAttribute("style","width: 100%;display:inline;margin-left:10px;"),t.appendChild(l),e.appendChild(t)}u.fileQueue.length&&(u.actionButtons.style.display="inline-block"),T.length&&u.options.invalidFilesErrorHandler(T,u.options)}},clearTransferQueue:function(){this.fileQueue=[],this.chunksQueue=[],this.fileErrors={},this.errors=0,this.totalFileChunks=0,this.totalUploadedChunks=0,this.activeTransfers=0,this.fileList.innerHTML="",this.actionButtons.style.display="none"},initTransfer:function(){var e=this;if(0===e.fileQueue.length)if(0===e.activeTransfers){var t=document.getElementById("_sg-uploader-fileProgressContainer"+this.instanceId);t&&t.remove(),e.actionButtons.style.display="none",e.errors?null!==this.options.error&&this.options.error.call(this):(!1!==e.waitingActiveTransfers.waitingFinalTransfers&&(clearTimeout(e.waitingActiveTransfers.waitingFinalTransfers),e.waitingActiveTransfers.waitingFinalTransfers=!1),null!==this.options.success&&this.options.success.call(this))}else!1===e.waitingActiveTransfers.waitingFinalTransfers&&(e.waitingActiveTransfers.waitingFinalTransfers=setTimeout(function(){e.waitingActiveTransfers.waitingFinalTransfers=!1,e.initTransfer()},100));else{var i=e.fileQueue.pop(),s=document.getElementById("_sg-uploader-fileProgressContainer"+e.instanceId+i);s&&(s.style.display="inline-flex"),e.transferFile(i)}},transferFile(e){var t=this,i=this.files[e];if(0===t.chunksQueue[e].length)return void 0!==t.waitingActiveTransfers[e]&&(clearTimeout(t.waitingActiveTransfers[e]),delete t.waitingActiveTransfers[e]),t.fileHasErrors(e)||t.updateFileStatus(e,!0),void setTimeout(function(){t.initTransfer()},0);if(t.activeTransfers+1>t.options.maxConcurrentTransfers)void 0===t.waitingActiveTransfers[e]&&(t.waitingActiveTransfers[e]=setTimeout(function(){delete t.waitingActiveTransfers[e],t.transferFile(e)},200));else{void 0!==t.waitingActiveTransfers[e]&&(clearTimeout(t.waitingActiveTransfers[e]),delete t.waitingActiveTransfers[e]);var s,r=t.chunksQueue[e].pop(),n=r.chunkId,a=r.totalChunks,l=i.name,o=i.size+"",u=t.options.maxRetries,d=new XMLHttpRequest;d.open("post",t.options.transferDestination,!0),d.setRequestHeader("Content-Type","application/octet-stream"),d.setRequestHeader("X-Chunk-Id",n),d.setRequestHeader("X-Chunk-Checksum",singularityUploader.util.calcCrc32(""+n+l+o)),d.setRequestHeader("X-Content-Length",o),d.setRequestHeader("X-Content-Name",l),d.setRequestHeader("X-Session-Name",t.options.sessionName),d.setRequestHeader("X-Chunk-Count",a),d.onerror=function(){r.retries>=u?t.handleError("chunk id :"+n+" transfer fail!"):(++r.retries,t.chunksQueue[e].push(r))},d.onreadystatechange=function(){if(4===d.readyState)if(--t.activeTransfers,200===d.status)if((s=JSON.parse(d.response)).success){if(t.fileHasErrors(e))return;++t.totalUploadedChunks,t.updateFileProgress(e,Math.round((a-t.chunksQueue[e].length)/a*100))}else if(s.recoverable){if(t.fileHasErrors(e))return;r.retries>=u?t.handleError("chunk id :"+n+" transfer fail!"):(++r.retries,t.chunksQueue[e].push(r))}else t.chunksQueue[e].length&&(t.fileErrors[e]=s.msg,t.chunksQueue[e]=[],++t.errors,t.updateFileStatus(e,!1,s.msg));else r.retries>=u?t.handleError("chunk id :"+n+" transfer fail!"):(++r.retries,t.chunksQueue[e].push(r))},++t.activeTransfers,d.send(1===a?i:i.slice(r.dataBegin,r.dataEnd)),setTimeout(function(){t.transferFile(e)},0)}},updateFileProgress:function(e,t){var i=document.getElementById("_sg-uploader-fileProgress"+this.instanceId+e);i&&(t+="%",i.style.width=t,i.innerHTML=t),this.updateOverallProgress()},updateOverallProgress:function(){var e=document.getElementById("_sg-uploader-fileProgress"+this.instanceId),t=Math.round(this.totalUploadedChunks/this.totalFileChunks*100)+"%";e&&(e.style.width=t,e.innerHTML=t)},updateFileStatus:function(e,t,i){i=i||"";var s=document.getElementById("_sg-uploader-fileStatusCheckbox"+this.instanceId+e),r=document.getElementById("_sg-uploader-fileStatusContainer"+this.instanceId+e),n=t?'<i class="fas fa-check" style="color:green;"></i> ':'<i class="fas fa-times" style="color:red;"></i> ';s&&s.remove(),r&&(r.innerHTML=n+i)},fileHasErrors:function(e){return void 0!==this.fileErrors[e]},handleError:function(e){console.log(e)},util:{hasClass:function(e,t){return-1!==e.className.indexOf(t.trim())},extend:function(){var e,t,i=arguments.length,s=!0===arguments[0],r=1;for(s?(r=2,e=arguments[1]):e=arguments[0];r<i;++r)(t=arguments[r])&&this.forEach(t,function(t,i){s&&e[i]&&("object"==typeof t||Array.isArray(t))?e[i]=singularityUploader.util.extend(e[i],t):e[i]=t});return e},forEach:function(e,t){var i;if(Array.isArray(e)){var s=e.length;for(i=0;i<s;++i)t(e[i],i)}else for(i in e)e.hasOwnProperty(i)&&t(e[i],i)},calcCrc32:function(e){var t=window.crcTable||[];if(!window.crcTable){var i,s,r;for(s=0;s<256;++s){for(i=s,r=0;r<8;++r)i=1&i?3988292384^i>>>1:i>>>1;t[s]=i}window.crcTable=t}var n,a=-1;for(n=0;n<e.length;++n)a=a>>>8^t[255&(a^e.charCodeAt(n))];return(-1^a)>>>0},extractFileExtensionFromString:e=>/(?:\.([^.]+))?$/.exec(e)[1]}};