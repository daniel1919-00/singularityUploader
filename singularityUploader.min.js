var singularityUploader={instances:[],create:function(e,t){var i=document.getElementById(e);if(!i)return console.log("Uploader Error: Invalid target!"),-1;if(this.util.hasClass(i,"_sg-uploader-container")){console.log("Duplicate instance!");var s=i.getAttribute("data-instance-id");return null!==s?Number(s):-1}t=t||{},t=this.util.extend(!0,{transferDestination:"",allowedFileExtensions:[],maxFileSize:null,maxConcurentTransfers:5,maxFileChunkSize:2097152,multipleFiles:!1,sessionName:"singularityUpload",maxRetries:3,success:null,error:null,uploadButtonText:"Upload"},t);var n=document.createElement("input");n.setAttribute("type","file"),n.setAttribute("class","_sg-uploader-input"),t.multipleFiles&&n.setAttribute("multiple","multiple"),t.allowedFileExtensions.length&&n.setAttribute("accept","."+t.allowedFileExtensions.join(",.")),n.options=t,n.fileQueue=[],n.chunksQueue=[],n.totalFileChunks=0,n.totalUploadedChunks=0,n.activeTransfers=0,n.waitingActiveTransfers={waitingFinalTransfers:!1},n.handleError=this.handleError,n.initTransfer=this.initTransfer,n.transferFile=this.transferFile,n.onchange=this.processInputFiles,n.updateFileProgress=this.updateFileProgress,n.updateOverallProgress=this.updateOverallProgress;var r=this.instances.push(n)-1;return n.instanceId=r,i.appendChild(n),i.classList.add("_sg-uploader-container"),i.setAttribute("data-instance-id",r),r},getInstance:function(e){return this.instances[e]},processInputFiles:function(){var e,t;if(this.fileList?((e=this.fileList).innerHTML="",t=!1,this.totalFileChunks=0,this.totalUploadedChunks=0):(e=document.createElement("ul"),t=!0),e){for(var i,s,n,r,a,l,o,u,d=this,c=0,f=d.options.maxFileChunkSize,p=0,h=d.files,g=h.length,v=d.instanceId,m=function(){this.checked?d.fileQueue.push(this.fileIndex):d.fileQueue.splice(this.fileIndex,1)};c<g;++c){if(r=h[c],i=document.createElement("li"),o=document.createElement("div"),n=document.createElement("label"),n.innerHTML="&nbsp; "+r.name,n.setAttribute("for","_sg-uploader-fileStatusCheckbox"+v+c),n.setAttribute("class","_sg-uploader-fileStatusCheckbox"),(s=document.createElement("input")).setAttribute("type","checkbox"),s.setAttribute("id","_sg-uploader-fileStatusCheckbox"+v+c),s.fileIndex=c,s.checked=!0,s.onchange=m,a=Math.ceil(r.size/f),d.totalFileChunks+=a,a<2)d.chunksQueue[c]=[{chunkId:0,retries:0,totalChunks:a}];else{for(l=[],p=0;p<a;++p)u=p*f,l.push({chunkId:p,retries:0,totalChunks:a,dataBegin:u,dataEnd:u+f});d.chunksQueue[c]=l.reverse()}d.fileQueue.push(c),i.appendChild(s),i.appendChild(n),o.innerHTML='<div id="_sg-uploader-fileProgressContainer'+v+c+'" class="_sg-uploader-fileProgress progress" style="width: 85px;display:none;vertical-align:middle;"><div id="_sg-uploader-fileProgress'+v+c+'" class="progress-bar" role="progressbar" style="width:0;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div></div>',o.setAttribute("class","_sg-uploader-fileStatus"),o.setAttribute("id","_sg-uploader-fileStatusContainer"+v+c),o.setAttribute("style","width: 100%;display:inline;margin-left:10px;"),i.appendChild(o),e.appendChild(i)}if(t){e.setAttribute("class","_sg-uploader-filesList"),e.setAttribute("id","_sg-uploader-filesList"+v);var T=document.createElement("div");T.innerHTML='<div id="_sg-uploader-fileProgressContainer'+v+'" class="_sg-uploader-fileProgress progress" style="width: 85px;display:none;vertical-align:middle;"><div id="_sg-uploader-fileProgress'+v+'" class="progress-bar" role="progressbar" style="width:0;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div></div>',d.parentNode.appendChild(T),d.parentNode.appendChild(e);var C=document.createElement("button");C.setAttribute("class","_sg-button _sg-button-primary"),C.innerHTML=d.options.uploadButtonText,C.onclick=function(e){e.preventDefault();var t=document.getElementById("_sg-uploader-fileProgressContainer"+d.instanceId);t&&(t.style.display="inline-flex"),d.initTransfer()},d.parentNode.appendChild(C),d.fileList=e}}},initTransfer:function(){var e=this;if(0===e.fileQueue.length)0===e.activeTransfers?(!1!==e.waitingActiveTransfers.waitingFinalTransfers&&(clearTimeout(e.waitingActiveTransfers.waitingFinalTransfers),e.waitingActiveTransfers.waitingFinalTransfers=!1),null!==this.options.success&&this.options.success.call(this)):!1===e.waitingActiveTransfers.waitingFinalTransfers&&(e.waitingActiveTransfers.waitingFinalTransfers=setTimeout(function(){e.waitingActiveTransfers.waitingFinalTransfers=!1,e.initTransfer()},100));else{var t=e.fileQueue.pop(),i=document.getElementById("_sg-uploader-fileProgressContainer"+e.instanceId+t);i&&(i.style.display="inline-flex"),e.transferFile(t)}},transferFile(e){var t=this,i=this.files[e];if(0===t.chunksQueue[e].length){void 0!==t.waitingActiveTransfers[e]&&(clearTimeout(t.waitingActiveTransfers[e]),delete t.waitingActiveTransfers[e]);var s=document.getElementById("_sg-uploader-fileStatusCheckbox"+t.instanceId+e),n=document.getElementById("_sg-uploader-fileStatusContainer"+t.instanceId+e);return s&&s.remove(),n&&(n.innerHTML='<i class="fas fa-check" style="color:green;"></i>'),void setTimeout(function(){t.initTransfer()},0)}if(t.activeTransfers+1>t.options.maxConcurentTransfers)void 0===t.waitingActiveTransfers[e]&&(t.waitingActiveTransfers[e]=setTimeout(function(){delete t.waitingActiveTransfers[e],t.transferFile(e)},200));else{void 0!==t.waitingActiveTransfers[e]&&(clearTimeout(t.waitingActiveTransfers[e]),delete t.waitingActiveTransfers[e]);var r,a=t.chunksQueue[e].pop(),l=a.chunkId,o=a.totalChunks,u=i.name,d=i.size+"",c=t.options.maxRetries,f=new XMLHttpRequest;f.open("post",t.options.transferDestination,!0),f.setRequestHeader("Content-Type","application/octet-stream"),f.setRequestHeader("X-Chunk-Id",l),f.setRequestHeader("X-Chunk-Checksum",singularityUploader.util.calcCrc32(""+l+u+d)),f.setRequestHeader("X-Content-Length",d),f.setRequestHeader("X-Content-Name",u),f.setRequestHeader("X-Session-Name",t.options.sessionName),f.setRequestHeader("X-Chunk-Count",o),f.onerror=function(){a.retries>=c?t.handleError("chunk id :"+l+" transfer fail!"):(++a.retries,i.chunksQueue.push(a))},f.onreadystatechange=function(){4===f.readyState&&(--t.activeTransfers,200===f.status&&(r=JSON.parse(f.response)).success?(++t.totalUploadedChunks,t.updateFileProgress(e,Math.round((o-t.chunksQueue[e].length)/o*100))):a.retries>=c?t.handleError("chunk id :"+l+" transfer fail!"):(++a.retries,i.chunksQueue.push(a)))},++t.activeTransfers,f.send(1===o?i:i.slice(a.dataBegin,a.dataEnd)),setTimeout(function(){t.transferFile(e)},0)}},updateFileProgress:function(e,t){var i=document.getElementById("_sg-uploader-fileProgress"+this.instanceId+e);i&&(t+="%",i.style.width=t,i.innerHTML=t),this.updateOverallProgress()},updateOverallProgress:function(){var e=document.getElementById("_sg-uploader-fileProgress"+this.instanceId),t=Math.round(this.totalUploadedChunks/this.totalFileChunks*100)+"%";e&&(e.style.width=t,e.innerHTML=t)},handleError:function(e){console.log(e)},util:{hasClass:function(e,t){return-1!==e.className.indexOf(t.trim())},extend:function(){var e,t,i=arguments.length,s=!0===arguments[0],n=1;for(s?(n=2,e=arguments[1]):e=arguments[0];n<i;++n)(t=arguments[n])&&this.forEach(t,function(t,i){s&&e[i]&&("object"==typeof t||Array.isArray(t))?e[i]=singularityUploader.util.extend(e[i],t):e[i]=t});return e},forEach:function(e,t){var i;if(Array.isArray(e)){var s=e.length;for(i=0;i<s;++i)t(e[i],i)}else for(i in e)e.hasOwnProperty(i)&&t(e[i],i)},calcCrc32:function(e){var t=window.crcTable||[];if(!window.crcTable){var i,s,n;for(s=0;s<256;++s){for(i=s,n=0;n<8;++n)i=1&i?3988292384^i>>>1:i>>>1;t[s]=i}window.crcTable=t}var r,a=-1;for(r=0;r<e.length;++r)a=a>>>8^t[255&(a^e.charCodeAt(r))];return(-1^a)>>>0}}};